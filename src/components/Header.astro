---
// src/components/Header.astro
import '../styles/global.css';
import { t, localizePath, LOCALES } from '../i18n/index';
export interface Props {
  lang?: string;
}
const { lang = 'ru' } = Astro.props;
---

<header class="header" id="navbar">
  <div class="container">
    <div class="header-content">
      <a href={localizePath('/', lang)} class="logo">HALCYON</a>
      <nav class="nav">
        <ul class="nav-list">
          <li><a href="#divorce">{t('nav.divorce', lang)}</a></li>
          <li><a href="#pretension">{t('nav.pretension', lang)}</a></li>
          <li><a href="#business">{t('nav.business', lang)}</a></li>
          <li><a href="#contact">{t('nav.contact', lang)}</a></li>
        </ul>
      </nav>
      <div class="language-switcher">
        {LOCALES.map(l => (
          <button
            class={`lang-btn ${l === lang ? 'active' : ''}`}
            data-lang={l}
            aria-label={`Switch to ${l.toUpperCase()}`}
          >
            {l === 'kz' ? 'ҚАЗ' : l === 'ru' ? 'РУС' : 'ENG'}
          </button>
        ))}
      </div>
      <!-- Mobile menu button -->
      <button class="burger" aria-label="Открыть меню" aria-expanded="false" aria-controls="mobile-menu">
        <span class="burger-line"></span>
        <span class="burger-line"></span>
        <span class="burger-line"></span>
      </button>
    </div>
  </div>
  <!-- Mobile menu overlay backdrop -->
  <div id="mobile-menu-backdrop" class="mobile-menu-backdrop" aria-hidden="true"></div>
  <!-- Mobile menu -->
  <div id="mobile-menu" class="mobile-menu" aria-hidden="true">
    <button class="mobile-close" aria-label="Закрыть меню">×</button>
    <ul class="mobile-nav-list">
      <li><a href="#divorce">{t('nav.divorce', lang)}</a></li>
      <li><a href="#pretension">{t('nav.pretension', lang)}</a></li>
      <li><a href="#business">{t('nav.business', lang)}</a></li>
      <li><a href="#contact">{t('nav.contact', lang)}</a></li>
    </ul>
    <div class="mobile-lang-switcher">
      {LOCALES.map(l => (
        <button
          class={`lang-btn ${l === lang ? 'active' : ''}`}
          data-lang={l}
        >
          {l === 'kz' ? 'ҚАЗ' : l === 'ru' ? 'РУС' : 'ENG'}
        </button>
      ))}
    </div>
  </div>
</header>

<style>
.header {
  position: fixed;
  top: 0;
  width: 100%;
  background: rgba(26, 26, 46, 0.95);
  backdrop-filter: blur(10px);
  z-index: 1000;
  padding: 1.5rem 0;
  box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
}

.header.scrolled {
  padding: 1rem 0;
  background: rgba(22, 33, 62, 0.98);
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1rem;
}

.logo {
  font-size: 2rem;
  font-weight: 700;
  background: var(--gradient-accent);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  cursor: pointer;
  text-decoration: none;
  transition: transform 0.3s ease;
}

.logo:hover {
  transform: scale(1.05);
}

.nav-list {
  display: flex;
  list-style: none;
  gap: 2.5rem;
  align-items: center;
}

.nav-list a {
  color: var(--text);
  text-decoration: none;
  font-weight: 500;
  transition: all 0.3s ease;
  position: relative;
}

.nav-list a::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--accent);
  transition: width 0.3s ease;
}

.nav-list a:hover::after {
  width: 100%;
}

.language-switcher {
  display: flex;
  gap: 0.5rem;
  border: 1px solid var(--accent);
  border-radius: 25px;
  padding: 0.4rem 0.8rem;
  background: rgba(201, 169, 97, 0.1);
}

.lang-btn {
  background: none;
  border: none;
  color: var(--text);
  cursor: pointer;
  padding: 0.3rem 0.8rem;
  border-radius: 15px;
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: 0.9rem;
}

.lang-btn.active {
  background: var(--accent);
  color: var(--primary);
}

.lang-btn:hover {
  transform: scale(1.1);
}

.burger {
  display: none;
}

.burger-line {
  width: 22px;
  height: 2px;
  background: var(--text);
  display: block;
}

/* Hide mobile menu by default on desktop */
.mobile-menu,
.mobile-menu-backdrop {
  display: none;
}

@media (max-width: 1024px) {
  .nav,
  .language-switcher {
    display: none;
  }

  .burger {
    display: inline-flex;
    background: transparent;
    border: none;
    flex-direction: column;
    gap: 4px;
    cursor: pointer;
  }

  .mobile-menu-backdrop {
    display: block;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: rgba(10, 10, 20, 0.95);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 300ms ease, visibility 300ms ease;
    pointer-events: none;
  }

  .mobile-menu-backdrop.open {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .mobile-menu {
    display: flex;
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: var(--primary);
    backdrop-filter: blur(10px);
    color: var(--text);
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding-top: 6rem;
    z-index: 1001;
    padding: 6rem 2rem 2rem;
    transform: translateX(100%);
    transition: transform 300ms ease;
    pointer-events: none;
  }

  .mobile-menu.open {
    transform: translateX(0);
    pointer-events: auto;
  }

  .mobile-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 2.5rem;
    cursor: pointer;
    line-height: 1;
  }

  .mobile-nav-list {
    list-style: none;
    padding: 0;
    margin: 0 0 2rem 0;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    align-items: center;
  }

  .mobile-nav-list a {
    font-size: 1.5rem;
    color: var(--text);
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .mobile-nav-list a:hover {
    color: var(--accent);
  }

  .mobile-lang-switcher {
    display: flex;
    gap: 0.5rem;
    border: 1px solid var(--accent);
    border-radius: 25px;
    padding: 0.4rem 0.8rem;
    background: rgba(201, 169, 97, 0.1);
  }
}
</style>

<script>
  // Mobile menu toggle
  (function () {
    const burger = document.querySelector('.burger');
    const mobileMenu = document.getElementById('mobile-menu');
    const backdrop = document.getElementById('mobile-menu-backdrop');
    const closeBtn = document.querySelector('.mobile-close');
    const mainContent = document.querySelector('main');
    let focusable = [];
    let firstFocusable = null;
    let lastFocusable = null;
    let onKeyDown;

    if (!burger || !mobileMenu || !backdrop) return;

    function updateFocusable() {
      const selectors = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
      focusable = Array.from(mobileMenu.querySelectorAll(selectors)).filter((el) => el.offsetParent !== null);
      firstFocusable = focusable[0] || closeBtn;
      lastFocusable = focusable[focusable.length - 1] || closeBtn;
    }

    function openMenu() {
      backdrop.classList.add('open');
      mobileMenu.classList.add('open');
      mobileMenu.setAttribute('aria-hidden', 'false');
      backdrop.setAttribute('aria-hidden', 'false');
      burger.setAttribute('aria-expanded', 'true');
      document.documentElement.style.overflow = 'hidden';
      if (mainContent) mainContent.setAttribute('aria-hidden', 'true');
      updateFocusable();
      (firstFocusable || closeBtn).focus();

      onKeyDown = function (e) {
        if (e.key === 'Tab') {
          if (focusable.length === 0) {
            e.preventDefault();
            (closeBtn).focus();
            return;
          }
          if (e.shiftKey) {
            if (document.activeElement === firstFocusable) {
              e.preventDefault();
              lastFocusable.focus();
            }
          } else {
            if (document.activeElement === lastFocusable) {
              e.preventDefault();
              firstFocusable.focus();
            }
          }
        } else if (e.key === 'Escape') {
          closeMenu();
        }
      };

      document.addEventListener('keydown', onKeyDown);
    }

    function closeMenu() {
      backdrop.classList.remove('open');
      mobileMenu.classList.remove('open');
      mobileMenu.setAttribute('aria-hidden', 'true');
      backdrop.setAttribute('aria-hidden', 'true');
      burger.setAttribute('aria-expanded', 'false');
      document.documentElement.style.overflow = '';
      if (mainContent) mainContent.removeAttribute('aria-hidden');
      burger.focus();
      if (onKeyDown) document.removeEventListener('keydown', onKeyDown);
    }

    burger.addEventListener('click', () => {
      const expanded = burger.getAttribute('aria-expanded') === 'true';
      if (expanded) closeMenu(); else openMenu();
    });

    if (closeBtn) closeBtn.addEventListener('click', closeMenu);

    // Close menu when clicking backdrop
    backdrop.addEventListener('click', closeMenu);

    mobileMenu.addEventListener('click', (e) => {
      if (e.target === mobileMenu) closeMenu();
    });

    // Close mobile menu when clicking nav links
    const mobileNavLinks = mobileMenu.querySelectorAll('.mobile-nav-list a');
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });
  })();

  // Language switcher for all lang buttons (desktop and mobile)
  (function () {
    function stripLocaleFromPath(pathname) {
      const parts = pathname.split('/').filter(Boolean);
      if (parts.length && ['kz', 'ru', 'en'].includes(parts[0])) {
        return '/' + parts.slice(1).join('/');
      }
      return pathname;
    }

    function localizePath(pathname, locale) {
      const basePath = stripLocaleFromPath(pathname) === '/' ? '' : stripLocaleFromPath(pathname);
      const newPath = `/${locale}${basePath}`.replace(/\/\/$/, '') || `/${locale}`;
      return newPath + (location.search || '') + (location.hash || '');
    }

    const langButtons = document.querySelectorAll('.lang-btn');
    langButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const locale = e.target.dataset.lang;
        const newUrl = localizePath(location.pathname, locale);
        location.assign(newUrl);
      });
    });
  })();
</script>
